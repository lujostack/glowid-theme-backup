<style>
  /* ==== Sektion-variabler ==== */
  #shopify-section-{{ section.id }} {
    --before-after-initial-cursor-position: {{ section.settings.cursor_initial_position }}%;
    --before-after-cursor-background: {{ section.settings.cursor_background.rgb }};
  }

  /* ==== Full width (kant till kant) ==== */
  .before-after--full { margin:0; padding:0; }
  .before-after--full .ba-full-bleed {
    position:relative; left:50%; right:50%;
    margin-left:-50vw; margin-right:-50vw;
    width:100vw; max-width:100vw; padding:0;
  }
  .before-after--full img { display:block; width:100%; height:auto; }

  /* ==== Overlay-innehåll och positionsval (mobil + desktop) ==== */
  .ba-content{position:absolute; inset:0; display:flex; padding:1.25rem; z-index:3;}
  .ba-pos-top{align-items:flex-start;} .ba-pos-middle{align-items:center;} .ba-pos-bottom{align-items:flex-end;}
  .ba-align-left{justify-content:flex-start;} .ba-align-center{justify-content:center;} .ba-align-right{justify-content:flex-end;}
  @media (min-width: 750px){
    .md\:ba-pos-top{align-items:flex-start;} .md\:ba-pos-middle{align-items:center;} .md\:ba-pos-bottom{align-items:flex-end;}
    .md\:ba-align-left{justify-content:flex-start;} .md\:ba-align-center{justify-content:center;} .md\:ba-align-right{justify-content:flex-end;}
  }

  /* ==== Egen maskning (oberöende av temats drag) ==== */
  /* Vi styr synlig del av AFTER-bilden via --ba-pct (0–100%) */
  #shopify-section-{{ section.id }} .before-after__after-image{
    --ba-pct: var(--before-after-initial-cursor-position, 50%);
    will-change: clip-path;
  }
  /* Horisontellt läge */
  #shopify-section-{{ section.id }}[data-ba-vertical="false"] .before-after__after-image{
    clip-path: inset(0 calc(100% - var(--ba-pct)) 0 0);
  }
  /* Vertikalt läge */
  #shopify-section-{{ section.id }}[data-ba-vertical="true"] .before-after__after-image{
    clip-path: inset(calc(100% - var(--ba-pct)) 0 0 0);
  }

  /* ==== Touch/drag-säkerhet ==== */
  before-after,
  .before-after__before-image,
  .before-after__after-image,
  .before-after__cursor { touch-action: none; }

  /* Låt overlayen inte blockera drag; men CTA ska vara klickbar */
  .ba-content{ pointer-events:none; }
  .ba-content a, .ba-content button, .ba-content [role="button"]{ pointer-events:auto; }

  /* Undvik iOS bild-drag/markering */
  .before-after img{ -webkit-user-drag:none; user-select:none; }

  /* Sätt cursorn synligt överst */
  .before-after__cursor{ z-index:4; }
</style>

<script>
/*
  EGEN DRAG-LOGIK (mobil/desktop):
  - Fångar drag var som helst på komponenten
  - Räknar ut procent (horis/vert)
  - Sätter CSS-variabeln --ba-pct som maskar AFTER-bilden
  - Flyttar även handtaget (cursor) visuellt
*/
document.addEventListener('DOMContentLoaded', function () {
  const root   = document.getElementById('shopify-section-{{ section.id }}');
  const slider = root && root.querySelector('before-after');
  if (!slider) return;

  const afterEl = slider.querySelector('.before-after__after-image');
  const cursor  = slider.querySelector('.before-after__cursor');

  // Sätt riktning (läser attributet 'vertical' som temat sätter)
  const vertical = slider.hasAttribute('vertical');
  root.dataset.baVertical = vertical ? 'true' : 'false';

  // Initiera procent från sektionens variabel
  let pct = parseFloat(getComputedStyle(root).getPropertyValue('--before-after-initial-cursor-position')) || 50;
  apply(pct);

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function getPercentFromPoint(clientX, clientY){
    const rect = slider.getBoundingClientRect();
    if (vertical){
      const p = ((clientY - rect.top) / rect.height) * 100;
      return clamp(p, 0, 100);
    } else {
      const p = ((clientX - rect.left) / rect.width) * 100;
      return clamp(p, 0, 100);
    }
  }

  function apply(p){
    // Uppdatera CSS-variabeln som styr maskningen
    root.style.setProperty('--ba-pct', p + '%');
    // Flytta handtaget visuellt
    if (cursor){
      if (vertical){ cursor.style.top = p + '%'; cursor.style.left = ''; }
      else { cursor.style.left = p + '%'; cursor.style.top = ''; }
    }
  }

  // Drag-hantering
  let startX=0, startY=0, dragging=false;

  function hasHorizontalIntent(x, y, sx, sy){
    const dx = Math.abs(x - sx), dy = Math.abs(y - sy);
    return vertical ? (dy > dx && dy > 3) : (dx > dy && dx > 3);
  }

  function onStart(e){
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY; dragging = false;

    // Tap = hoppa till den punkten direkt (som tidigare)
    pct = getPercentFromPoint(t.clientX, t.clientY);
    apply(pct);
  }

  function onMove(e){
    const t = e.touches ? e.touches[0] : e;
    if (!dragging){
      if (e.touches && !hasHorizontalIntent(t.clientX, t.clientY, startX, startY)) return; // låt sidan scrolla om fel riktning
      dragging = true;
    }
    if (e.cancelable) e.preventDefault(); // stoppa sid-scroll under aktiv drag
    pct = getPercentFromPoint(t.clientX, t.clientY);
    apply(pct);
  }

  function onEnd(){ dragging = false; }

  // Lyssnare – touch/pointer/mus
  slider.addEventListener('touchstart', onStart, { passive: true });
  slider.addEventListener('touchmove',  onMove,  { passive: false });
  slider.addEventListener('touchend',   onEnd,   { passive: true });
  slider.addEventListener('touchcancel',onEnd,   { passive: true });

  slider.addEventListener('pointerdown', onStart);
  slider.addEventListener('pointermove', onMove);
  slider.addEventListener('pointerup',   onEnd);
  slider.addEventListener('pointercancel', onEnd);

  slider.addEventListener('mousedown', onStart);
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup',   onEnd);
});
</script>

{%- if request.design_mode or section.blocks.size > 0 -%}
  <div class="before-after-wrapper {% if section.settings.full_width %}before-after--full{% endif %}">
    <div class="{% if section.settings.full_width %}ba-full-bleed{% else %}section-spacing color-scheme color-scheme--{{ section.settings.color_scheme.id }}{% endif %} {% if section.settings.separate_section_with_border %}bordered-section{% endif %}">
      <div class="{% unless section.settings.full_width %}container container--lg{% endunless %}">
        <div class="section-stack">
          {%- render 'section-header', subheading: section.settings.subheading, heading: section.settings.title, content: section.settings.content -%}

          {%- if request.design_mode and section.blocks.size < 2 -%}
            {%- assign error_message = 'sections.before_after.not_enough_blocks' | t -%}
            {%- render 'banner', content: error_message, status: 'error', text_alignment: 'center' -%}
          {%- endif -%}

          <before-after class="before-after before-after--{{ section.settings.cursor_direction }}" {% if section.settings.cursor_direction == 'vertical' %}vertical{% endif %}>
            {%- for block in section.blocks -%}
              {%- if block.type == 'before' -%}
                {%- assign container_class = 'before-after__before-image' -%}
                {%- assign image_class = 'w-full' -%}
              {%- else -%}
                {%- assign container_class = 'before-after__after-image' -%}
                {%- assign image_class = 'image-background' -%}
              {%- endif -%}

              <div class="{{ container_class }} color-scheme color-scheme--{{ block.settings.color_scheme.id }}" {{ block.shopify_attributes }}>
                {%- capture sizes -%}(max-width: 999px) 100vw, min(1260px, 100vw){%- endcapture -%}

                {%- if block.settings.image != blank or block.settings.mobile_image != blank -%}
                  <picture>
                    {%- if block.settings.mobile_image -%}
                      <source
                        media="(max-width: 749px)"
                        srcset="{{ block.settings.mobile_image | image_url: width: 600 }} 600w, {{ block.settings.mobile_image | image_url: width: 900 }} 900w, {{ block.settings.mobile_image | image_url: width: 1200 }} 1200w"
                        width="{{ block.settings.mobile_image.width }}"
                        height="{{ block.settings.mobile_image.height }}"
                      >
                    {%- endif -%}
                    {%- if block.settings.image -%}
                      {{- block.settings.image
                        | image_url: width: block.settings.image.width
                        | image_tag: sizes: sizes, widths: '800,1000,1400,1600,2000,2400', class: image_class, draggable: false, loading: 'lazy' -}}
                    {%- endif -%}
                  </picture>
                {%- else -%}

                  {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder' }}
                {%- endif -%}

                {%- comment -%} Content overlay (text + CTA) {%- endcomment -%}
                {%- if block.settings.text != blank or block.settings.link_text != blank -%}
                  {%- capture mobile_classes -%}
                    ba-pos-{{ block.settings.mobile_content_position | split: '_' | first }}
                    ba-align-{{ block.settings.mobile_content_position | split: '_' | last }}
                  {%- endcapture -%}
                  {%- capture desktop_classes -%}
                    md:ba-pos-{{ block.settings.desktop_content_position | split: '_' | first }}
                    md:ba-align-{{ block.settings.desktop_content_position | split: '_' | last }}
                  {%- endcapture -%}

                  <div class="ba-content v-stack gap-3 {{ mobile_classes | strip }} {{ desktop_classes | strip }}" style="text-align:center;">
                    {%- if block.settings.text != blank -%}
                      <p class="h6 sm:h5">{{ block.settings.text }}</p>
                    {%- endif -%}
                    {%- if block.settings.link_text != blank -%}
                      {%- render 'button',
                        href: block.settings.link_url,
                        content: block.settings.link_text,
                        style: block.settings.link_style,
                        background: block.settings.button_background,
                        text_color: block.settings.button_text_color
                      -%}
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>
            {%- endfor -%}

            <div class="before-after__cursor" tabindex="0">
              <span class="sr-only">{{ 'sections.before_after.cursor_accessibility_text' | t }}</span>
              <svg role="presentation" focusable="false" fill="none" width="50" height="50" viewBox="0 0 50 50">
                <g {% if section.settings.cursor_direction == 'vertical' %}transform="rotate(90, 25, 25)"{% endif %}>
                  <rect width="50" height="50" rx="25" fill="{{ section.settings.cursor_background }}"/>
                  <path d="m19.25 19-6 6 6 6m11.5 0 6-6-6-6" stroke="{{ section.settings.cursor_arrows_color }}" stroke-width=".75" stroke-linecap="square"/>
                </g>
              </svg>
            </div>
          </before-after>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Before/after (Full width)",
  "class": "shopify-section--before-after-image",
  "tag": "section",
  "settings": [
    { "type": "checkbox", "id": "full_width", "label": "Full width (kant till kant)", "default": true },
    { "type": "color_scheme", "id": "color_scheme", "label": "Färgtema", "default": "scheme-1" },
    { "type": "checkbox", "id": "separate_section_with_border", "label": "Separat sektion med ram", "default": false },
    { "type": "inline_richtext", "id": "subheading", "label": "Underrubrik" },
    { "type": "inline_richtext", "id": "title", "label": "Rubrik", "default": "Before/after" },
    { "type": "richtext", "id": "content", "label": "Text", "default": "<p>Visa resultat före/efter i helbredd.</p>" },
    { "type": "select", "id": "cursor_direction", "label": "Riktningsval", "options": [{ "value": "horizontal", "label": "Horisontell" }, { "value": "vertical", "label": "Vertikal" }], "default": "horizontal" },
    { "type": "range", "id": "cursor_initial_position", "min": 0, "max": 100, "unit": "%", "label": "Startposition", "default": 50 },
    { "type": "color", "id": "cursor_background", "label": "Bakgrundsfärg markör", "default": "#ffffff" },
    { "type": "color", "id": "cursor_arrows_color", "label": "Pilfärg markör", "default": "#000000" }
  ],
  "blocks": [
    {
      "type": "before",
      "name": "Before",
      "limit": 1,
      "settings": [
        { "type": "color_scheme", "id": "color_scheme", "label": "Färgtema", "default": "scheme-4" },
        { "type": "image_picker", "id": "image", "label": "Desktop-bild (före)" },
        { "type": "image_picker", "id": "mobile_image", "label": "Mobil-bild (före)" },
        { "type": "inline_richtext", "id": "text", "label": "Text", "default": "Before" },
        { "type": "text", "id": "link_text", "label": "Knapptext" },
        { "type": "url", "id": "link_url", "label": "Knapp-länk" },
        {
          "type": "select",
          "id": "link_style",
          "label": "Knapp-stil",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "outline", "label": "Outline" },
            { "value": "link", "label": "Länk" }
          ],
          "default": "solid"
        },
        { "type": "color", "id": "button_background", "label": "Knapp-bakgrund", "default": "#ffffff" },
        { "type": "color", "id": "button_text_color", "label": "Knapp-textfärg", "default": "#000000" },
        { "type": "header", "content": "Content position" },
        {
          "type": "select",
          "id": "mobile_content_position",
          "label": "Mobile content position",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ],
          "default": "bottom_center"
        },
        {
          "type": "select",
          "id": "desktop_content_position",
          "label": "Desktop content position",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ],
          "default": "bottom_center"
        }
      ]
    },
    {
      "type": "after",
      "name": "After",
      "limit": 1,
      "settings": [
        { "type": "color_scheme", "id": "color_scheme", "label": "Färgtema", "default": "scheme-4" },
        { "type": "image_picker", "id": "image", "label": "Desktop-bild (efter)" },
        { "type": "image_picker", "id": "mobile_image", "label": "Mobil-bild (efter)" },
        { "type": "inline_richtext", "id": "text", "label": "Text", "default": "After" },
        { "type": "text", "id": "link_text", "label": "Knapptext" },
        { "type": "url", "id": "link_url", "label": "Knapp-länk" },
        {
          "type": "select",
          "id": "link_style",
          "label": "Knapp-stil",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "outline", "label": "Outline" },
            { "value": "link", "label": "Länk" }
          ],
          "default": "solid"
        },
        { "type": "color", "id": "button_background", "label": "Knapp-bakgrund", "default": "#ffffff" },
        { "type": "color", "id": "button_text_color", "label": "Knapp-textfärg", "default": "#000000" },
        { "type": "header", "content": "Content position" },
        {
          "type": "select",
          "id": "mobile_content_position",
          "label": "Mobile content position",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ],
          "default": "bottom_center"
        },
        {
          "type": "select",
          "id": "desktop_content_position",
          "label": "Desktop content position",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ],
          "default": "bottom_center"
        }
      ]
    }
  ],
  "presets": [
    { "name": "Before/after (full width)", "blocks": [{ "type": "before" }, { "type": "after" }] }
  ]
}
{% endschema %}
